extern _malloc

section .text

global _ft_malloc

;void	*ft_malloc(size_t size);
;======================================================================
_ft_malloc :

;	align the stack
;----------------------------------------------------------------------
	push		r12
	call		_get_alignment_offset
	mov			r12, rax
	sub			rsp, rax
;----------------------------------------------------------------------

	call		_malloc

;	restore the stack state before adjustement
;----------------------------------------------------------------------
	add			rsp, r12
	pop			r12
;----------------------------------------------------------------------

	ret
;======================================================================


;	8 if not aligned | 0 otherwise
;======================================================================
_get_alignment_offset :
;	store the rsp % 16 in rax
;----------------------------------------------------------------------
	mov			rdx, 0
	mov			rax, rsp
	mov			rcx, 16
	div			rcx
;----------------------------------------------------------------------

;	rax == 0 -> not aligned (return address of align_stack)
;----------------------------------------------------------------------
	cmp			rdx, 0
	je			_update_offset
	mov			rax, 0
	ret
;----------------------------------------------------------------------


_update_offset :
	mov			rax, 8
	ret
;======================================================================
